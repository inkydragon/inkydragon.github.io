---
slug: nvda-internals-8
title: NVDA 内幕故事8：蜂鸣声与拼写错误
authors: [Joseph, cyhan]
tags: [nvda-internals, 译文]
---

本文为[《内幕故事》][1]系列英文译文的第八篇。
这次回答了一个关于拼写错误蜂鸣声的问题，原问题已被锁定。

对于新读者：《内幕故事》系列文章详细介绍了 NVDA 的内部工作原理。

<!-- truncate -->

到目前为止，我们介绍了 NVDA 的组件、睡眠模式和 NVDA 对象。
对于那些对屏幕阅读器（更具体地说，是 NVDA）工作原理感兴趣的朋友，这是一个向我提问的机会
（或者像 Reddit 上的人们所说的那样，是 AMA）。
有时这些文章可能会有点复杂，所以我会尽力简化它。


## 拼写错误

几天前，一位会员询问 [NVDA 是否可以检测 Microsoft PowerPoint 中的拼写错误][3]，答案是否定的。
但为什么 NVDA 在编写或查看幻灯片时无法检测拼写错误呢？
事实证明，这取决于应用程序是否愿意将此类信息提供给 NVDA，从而允许 NVDA 检测格式标记和其他文本信息。
NVDA 中包含一个名为“可编辑文本”的模块。
顾名思义，此模块负责提供对可编辑文本字段的支持。
它的职责之一是提供文本导航命令的基本实现以及对编辑字段的输入支持。
这反过来又驱动了一组也称为“可编辑文本”的行为，这些行为定义了诸如建议和拼写错误检测之类的附加功能。
为了充分利用可编辑文本字段支持，NVDA 保留了对所谓“文本信息”的引用，这是一种用于文本导航和与各种控件交互的工具。
但这还不是全部：为了获得更好的体验（例如显示格式标记），NVDA 正在使用的可编辑文本字段，
应该愿意通过辅助功能 API 和其他工具公开各种文本信息。


## 字符输入事件

说到拼写错误检测（这篇《内幕故事》文章的重点），这涉及到输入钩子和一个名为“typed character”的事件。
输入钩子是一个非常高级的话题，我并不完全理解，
但我可以说的是，它有助于 NVDA 识别你输入的按键
（NVDA 甚至知道我在撰写这篇文章时按下的键盘按键）。
作为字符输入处理的一部分，会调用 typed character 事件，它通常采用以下函数签名：

```python
def event_typedCharacter(self, ch):
    # do something
```

其中 `self` 是 NVDA 对象（可能是焦点控件），`ch` 是正在处理的字符。

在大多数情况下，如果“朗读输入字符”（`NvDA+数字行 2`）处于关闭状态，NVDA 将保持静音；
如果处于打开状态，NVDA 将朗读输入的字符。

字符输入事件在实际的可编辑文本字段或真正的文本编辑字段行为中工作方式截然不同
（我们不妨在未来专门写一篇文章来讨论 NVDA 对象和行为，例如可编辑文本和进度条）。
可编辑文本字段行为要做的第一件事是检查输入和输出处理步骤中是否都启用了拼写错误检测。
输出步骤通过文档格式设置中的“拼写错误”复选框进行检查，
输入部分由键盘设置中的“键入时播放拼写错误的声音”复选框控制；
必须同时选中这两个复选框，以便在检测到拼写错误时让 NVDA 发出哔哔声，
不是由 NVDA 发出，而是由应用程序（更具体地说，由相关的可编辑文本字段）发出通知。


## 拼写错误检测

如果拼写错误检测确实已启用，并且输入的最后一个字符不是字母数字字符，
也不是当前输入语言中表示单词边界的任何字符（标点符号、换行符、空格等），
NVDA 将在可编辑文本基类的行为中调用一个名为 `_reportErrorInPreviousWord` 的私有函数
（注意下划线，这是 Python 中标记私有内容的常用方法）。
这个私有函数的作用是询问可编辑文本字段，输入的文本是否被标记为拼写错误，具体操作如下：

1. 找出系统插入符号的位置，否则报告输入文本的拼写错误就没有意义了。
1. 根据系统插入符号获取文本信息。
1. 使用文本信息命令，向左移动两个字符（完全不移动插入符号）。
    如果只移动到前一个字符（向左移动一个字符），NVDA 会将光标定位到非单词的位置，
    因此 NVDA 必须向左移动两个字符。
1. 询问文本字段是否有格式标记（如果有）。
    如果 NVDA 无法从相关控件获取任何内容，则拼写错误检测将不起作用。
1. 如果返回格式标记，NVDA 会检查是否存在名为“invalid-spelling”的标记，
    如果存在，则会播放拼写错误提示音。
    同样，如果 NVDA 能够获取可编辑文本字段所传递的格式标记，则此方法有效。

接下来的问题是：“NVDA 可以在所有应用中播报拼写错误吗？” 答案是否定的。
这取决于获得焦点的控件是否向 NVDA 返回有用的格式标记，
如果 NVDA 能够获取这些标记，则可能播放拼写错误提示音。
某些控件虽然返回了其他格式标记，但并未将拼写错误标记传达给 NVDA；
而某些控件（例如 PowerPoint 幻灯片区域）则不返回所需的标记，
或者需要额外的步骤才能获取它们。


## 两种设置

另一个后续问题是：“为什么 NVDA 将拼写错误检测拆分成两个独立的设置？”
阅读和书写文本虽然都与文本相关，但就用户交互和屏幕阅读而言，却是两种不同的操作。
阅读文本需要使用任何内容和附加标记，并且只专注于信息呈现。
另一方面，输入需要屏幕阅读器准确知道按下了哪个键，以及操作系统和应用程序看到了哪个键，
然后执行与输入相关的其他操作，例如处理输入的字符，并在用户和相关应用程序/控件允许的情况下检测拼写。
这就是为什么文档格式设置中的拼写错误复选框用于文本审核，
而键入时拼写错误提示复选框用于输入，因此位于键盘设置中
（希望这可以回答一个问题：为什么某些设置位于特定的设置面板中，而乍一看可能并没有什么意义）。

注意：所述程序相关的描述适用于 NVDA 2023.1

希望以上内容对您有所帮助。
如有任何问题、评论、疑虑或想写情书，欢迎反馈。

Cheers,
Joseph


## 评论与回复

- 评论有人吐槽了 Win XP 时代，Access 数据库编辑区域的可访问性问题。有些软件获得关注度不够。
- 另一个评论则回复：“看上去唯一的选择是给微软写反馈，要求他们改进可访问性”


## 译注

译自 Joseph Lee - [The Inside Story of NVDA: bleep, spelling error (2021-02-26)][2]
(2023-02-27)

- 截至2025年6月，本文是《内幕故事》的最后一篇文章。


[1]: https://nvdacn.com/index.php/tag/NVDA-%E5%86%85%E5%B9%95%E6%95%85%E4%BA%8B/
[2]: https://nvda.groups.io/g/nvda/topic/97259430#103929
[3]: https://nvda.groups.io/g/nvda/topic/97219888#msg103867
